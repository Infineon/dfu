<!-- HTML header for doxygen 1.8.13-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.14"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Device Firmware Update (DFU) Middleware Library 5.1</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
  $(document).ready(initResizable);
/* @license-end */</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen_style.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><a href="https://www.infineon.com/"><img alt="Logo" src="logo.png"/></a></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Device Firmware Update (DFU) Middleware Library 5.1</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.14 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('index.html','');});
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">Device Firmware Update (DFU) Middleware Library 5.1 Documentation</div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h1><a class="anchor" id="section_mainpage_overview"></a>
Overview</h1>
<p>The purpose of the DFU middleware library is to provide an SDK for updating firmware images. The middleware allows creating these types of projects:</p>
<ul>
<li>The application loader receives the program and switch to the new application.</li>
<li>A loadable application is transferred and programmed.</li>
</ul>
<p>A project can contain the features of both types.</p>
<h1><a class="anchor" id="section_dfu_general"></a>
General Description</h1>
<p>Include cy_dfu.h to get access to all functions and other declarations in this library.</p>
<p>The DFU SDK has the following features:</p><ul>
<li>Reads firmware images from a host through a number of transport interfaces, e.g. USB, UART, I2C, SPI</li>
<li>Supports dynamic switching (during runtime) of the communication interfaces</li>
<li>Provides ready-for-use transport interface templates based on HAL drivers for CAT1 devices and PDL drivers for CAT2 devices</li>
<li>Supported flows: Basic bootloader and MCUBoot compatibility</li>
<li>Device support: CAT1A, CAT2 (Basic bootloader flow), CAT1C (MCUBoot compatibility flow)</li>
<li>Programs a firmware image to the specified address in internal flash, XIP region or any external memory that supports the DFU API</li>
<li>Copies applications</li>
<li>Validates applications</li>
<li>Updates safely - updates at a temporary location, validates, and if valid, overwrites the working image</li>
<li>Switches applications - passes parameters in RAM when switching applications</li>
<li>Supports encrypted image files - transfers encrypted images without decrypting in the middle</li>
<li>Supports many application images - the number of applications is limited only by the metadata size; each image can be an application loader, for example, 512-byte metadata supports up to 63 applications</li>
<li>Supports customization</li>
<li>Supports the CRC-32 checksum to validate data.</li>
<li>Supports extend of the host command/response protocol with custom commands.</li>
</ul>
<h1><a class="anchor" id="section_dfu_quick_start"></a>
Quick Start Guide</h1>
<h2><a class="anchor" id="subsection_dfu_qsg_basic"></a>
Basic Bootloader Flow</h2>
<p>The DFU SDK is used to design updating applications of arbitrary flexibility and complexity. Infineon DFU middleware can be used in various software environments. For details, refer to RELEASE.md file. For a quick start, use the Code Examples. The portfolio of Code Examples continuously extends at <a href="https://github.com/Infineon/Code-Examples-for-ModusToolbox-Software">Infineon GitHub</a>.</p>
<p>The ModusToolbox(TM) Quick Start Guide (QSG) assumes ModusToolbox(TM) 3.x is installed with all required tools.</p>
<p>The following steps are to set up and build a basic DFU loader and loadable applications. The DFU loader application uses the I2C transport interface. The steps assume that the user builds an application for CY8CKIT-062-WIFI-BT (CAT1A device) or CY8CKIT-149 kits (CAT2 device) based on a starter Hello_World ModusToolbox(TM) project.</p>
<dl class="section note"><dt>Note</dt><dd>For other kits or devices, update default linker scripts with the valid memory addresses. For details, refer to <a class="el" href="index.html#group_dfu_config_linker_scripts">Linker scripts</a>.</dd></dl>
<h3><a class="anchor" id="ssection_dfu_step_0"></a>
STEP 0: Projects preparation</h3>
<ol type="1">
<li>Create a project for CY8CKIT-062-WIFI-BT or CY8CKIT-149 with the DFU loader application using the Hello_World template application ("Getting started" section in the Project Creator). Name it "QSG_DFU_App0_I2C". For details, refer to the ModusToolbox(TM) 3.x IDE Quick Start Guide.</li>
<li>Create a project for the DFU loadable application in the same way and name it "QSG_DFU_App1_Hello_World".</li>
<li>Include the DFU middleware into each project using the ModusToolbox(TM) Library Manager or download it from GitHub and copy it to the project manually.</li>
<li>Include a DFU header in main.c of each project to get access to DFU API: <div class="fragment"><div class="line"><span class="preprocessor">#include &quot;cy_dfu.h&quot;</span></div></div><!-- fragment --> </li>
</ol>
<h3><a class="anchor" id="ssection_dfu_step_1"></a>
STEP 1: Setup Loader Application QSG_DFU_App0_I2C</h3>
<ol type="1">
<li><p class="startli">Copy the app0 linker script files and put them next to main.c:</p><ul>
<li>For CY8CKIT-062-WIFI-BT kit: <br />
 [DFU location]\linker_scripts\CAT1A\TOOLCHAIN_&lt;COMPILER&gt;\dfu_cm4_app0.[ext]</li>
<li>For CY8CKIT-149 kit: <br />
 [DFU location]\linker_scripts\CAT2\TOOLCHAIN_&lt;COMPILER&gt;\dfu_cm0p_app0.[ext] <br />
 [DFU location] - The folder with the DFU library downloaded in STEP 0 <br />
 [ext] - The linker script extension according to the used compiler.</li>
</ul>
<p class="startli">For example, for CY8CKIT-062-WIFI-BT kit and GCC ARM compiler, with DFU loaded by the Library Manager as a "Shared Git Repo" copy <br />
 ..\mtb_shared\dfu\[VERSION]\linker_scripts\CAT1A\TOOLCHAIN_GCC_ARM\dfu_cm4_app0.ld file</p>
<dl class="section note"><dt>Note</dt><dd>For ARM compiler, copy additional <b>dfu_common.h</b> and <b>dfu_elf_symbols.c</b> files to the project. Those files are located in the same folder as the selected linker file.</dd></dl>
</li>
<li>Update project's Makefile to add DFU user and I2C transport components : locate the <b>COMPONENTS</b> variable and add <b>DFU_USER</b> and <b>DFU_I2C</b>: <div class="fragment"><div class="line">COMPONENTS=DFU_USER DFU_I2C </div></div><!-- fragment --></li>
<li><p class="startli">For CY8CKIT-149 kit, configure the I2C communication interface. </p><dl class="section warning"><dt>Warning</dt><dd>Not needed for the CAT1 devices - configuration is done by HAL.<br />
 Please check/setup the required pins assignments in the BSP.</dd></dl>
<p>Open the ModusToolbox(TM) Device Configurator and enable SCB on the Peripheral tab under Communication section with the following parameter.</p>
<p class="startli">For CY8CKIT-149, SCB 1 is connected to the KitProg. </p><table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">SCB parameter name  </th><th class="markdownTableHeadNone">Value   </th></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyNone">Personality  </td><td class="markdownTableBodyNone">I2C   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowEven">
<td class="markdownTableBodyNone">Name  </td><td class="markdownTableBodyNone"><b>DFU_I2C</b>   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyNone">Mode  </td><td class="markdownTableBodyNone">Slave   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowEven">
<td class="markdownTableBodyNone">Data Rate (kbps)  </td><td class="markdownTableBodyNone">100   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyNone">Slave Address (7-bit)  </td><td class="markdownTableBodyNone">12   </td></tr>
</table>
<dl class="section warning"><dt>Warning</dt><dd>The SCB personality must be <b>I2C</b> and the name must be <b>DFU_I2C</b>.</dd></dl>
<div class="image">
<img src="dfu_basic_i2c_kit149.png" alt="dfu_basic_i2c_kit149.png"/>
</div>
<p class="startli">See <a class="el" href="index.html#group_dfu_mtb_cfg">Use of the ModusToolbox(TM) tools for HW initialization</a></p>
</li>
</ol>
<h3><a class="anchor" id="ssection_dfu_step_2"></a>
STEP 2: Update Loader QSG_DFU_App0_I2C main.c</h3>
<ol type="1">
<li>Include a DFU reset handler to start the appropriate application after a reset: <div class="fragment"><div class="line"><span class="comment">/*******************************************************************************</span></div><div class="line"><span class="comment">* Function Name: Cy_OnResetUser</span></div><div class="line"><span class="comment">********************************************************************************</span></div><div class="line"><span class="comment">*</span></div><div class="line"><span class="comment">*  This function is called at the start of Reset_Handler().</span></div><div class="line"><span class="comment">*  DFU requires it to call Cy_DFU_OnResetApp0() in app#0.</span></div><div class="line"><span class="comment">*</span></div><div class="line"><span class="comment">*******************************************************************************/</span></div><div class="line"><span class="keywordtype">void</span> Cy_OnResetUser(<span class="keywordtype">void</span>)</div><div class="line">{</div><div class="line"><span class="preprocessor">#if CY_DFU_FLOW == CY_DFU_BASIC_FLOW</span></div><div class="line">    <a class="code" href="group__group__dfu__functions__app.html#ga6e0defdaf9adb2e5663dc6144dc6823a">Cy_DFU_OnResetApp0</a>();</div><div class="line"><span class="preprocessor">#endif </span><span class="comment">/* CY_DFU_FLOW == CY_DFU_BASIC_FLOW */</span><span class="preprocessor"></span></div><div class="line">}</div></div><!-- fragment --></li>
<li>Initialize the variables and call the DFU initialization function: <div class="fragment"><div class="line">    <span class="comment">/*</span></div><div class="line"><span class="comment">    * Used to count seconds</span></div><div class="line"><span class="comment">    */</span></div><div class="line">    uint32_t count = 0;</div><div class="line"></div><div class="line">    <span class="comment">/* Status codes for DFU API */</span></div><div class="line">    <a class="code" href="group__group__dfu__enums.html#gafcff247e9cb8dc6c1282873b0d2dae1b">cy_en_dfu_status_t</a> status;</div><div class="line"></div><div class="line">    <span class="comment">/*</span></div><div class="line"><span class="comment">    * DFU state, one of the:</span></div><div class="line"><span class="comment">    * - CY_DFU_STATE_NONE</span></div><div class="line"><span class="comment">    * - CY_DFU_STATE_UPDATING</span></div><div class="line"><span class="comment">    * - CY_DFU_STATE_FINISHED</span></div><div class="line"><span class="comment">    * - CY_DFU_STATE_FAILED</span></div><div class="line"><span class="comment">    */</span></div><div class="line">    uint32_t state;</div><div class="line"></div><div class="line">    <span class="comment">/* Timeout for Cy_DFU_Continue(), in milliseconds */</span></div><div class="line">    <span class="keyword">const</span> uint32_t paramsTimeout = 20u;</div><div class="line"></div><div class="line">    <span class="comment">/* Buffer to store DFU commands */</span></div><div class="line">    CY_ALIGN(4) static uint8_t buffer[<a class="code" href="group__group__dfu__macro__config.html#ga01f0e598d60b05879166f93ef38cecee">CY_DFU_SIZEOF_DATA_BUFFER</a>];</div><div class="line"></div><div class="line">    <span class="comment">/* Buffer for DFU data packets for transport API */</span></div><div class="line">    CY_ALIGN(4) static uint8_t packet[<a class="code" href="group__group__dfu__macro__config.html#ga21b70d16eb321a6d2010b92c8584b782">CY_DFU_SIZEOF_CMD_BUFFER</a> ];</div><div class="line"></div><div class="line">    <span class="comment">/* DFU params, used to configure DFU */</span></div><div class="line">    <a class="code" href="group__group__dfu__data__structs.html#structcy__stc__dfu__params__t">cy_stc_dfu_params_t</a> dfuParams;</div><div class="line"></div><div class="line">    <span class="comment">/* Initialize dfuParams structure */</span></div><div class="line">    dfuParams.timeout          = paramsTimeout;</div><div class="line">    dfuParams.dataBuffer       = &amp;buffer[0];</div><div class="line">    dfuParams.packetBuffer     = &amp;packet[0];</div><div class="line"></div><div class="line">    status = <a class="code" href="group__group__dfu__functions.html#ga803512d54a676efd3ecfd12f531c2e30">Cy_DFU_Init</a>(&amp;state, &amp;dfuParams);</div><div class="line"></div><div class="line">    <span class="comment">/* Stop program execution if DFU init failed */</span></div><div class="line">    CY_ASSERT(<a class="code" href="group__group__dfu__enums.html#ggafcff247e9cb8dc6c1282873b0d2dae1ba225cb8ce9902215fa03c9b0c77ac6e23">CY_DFU_SUCCESS</a> == status);</div><div class="line"></div><div class="line">    <span class="comment">/* Set up the device based on configurator selections */</span></div><div class="line">    init_cycfg_all();</div><div class="line"></div><div class="line">    <span class="comment">/* enable interrupts */</span></div><div class="line">    __enable_irq();</div></div><!-- fragment --></li>
<li>Initialize the DFU transport layer: <div class="fragment"><div class="line">    <span class="comment">/* Initialize DFU communication */</span></div><div class="line">    <a class="code" href="group__group__dfu__functions__transport.html#gae72c860849c0ede5b2a34eaea7acbb64">Cy_DFU_TransportStart</a>(<a class="code" href="group__group__dfu__enums.html#gga375b46c7413cecb3fdc63f8d4638d137a74f139ec8e316257d10b026bedb02bdd">CY_DFU_I2C</a>);</div></div><!-- fragment --></li>
<li>Update the main loop with the Host Command/Response protocol processing: <div class="fragment"><div class="line">        status = <a class="code" href="group__group__dfu__functions.html#ga6514a9d999be746edc406fcf764d07f5">Cy_DFU_Continue</a>(&amp;state, &amp;dfuParams);</div><div class="line">        ++count;</div><div class="line"></div><div class="line">        <span class="keywordflow">if</span> (state == <a class="code" href="group__group__dfu__macro__state.html#ga75352e8101b5fe7c4de37f86b06f1d18">CY_DFU_STATE_FINISHED</a>)</div><div class="line">        {</div><div class="line">           <span class="comment">/* Finished loading the application image */</span></div><div class="line"></div><div class="line">           <span class="comment">/* Validate DFU application, if it is valid then switch to it */</span></div><div class="line">           status = <a class="code" href="group__group__dfu__functions__app.html#gae4eed95b94cdb006c79e2036f01d7fc4">Cy_DFU_ValidateApp</a>(1u, &amp;dfuParams);</div><div class="line">           <span class="keywordflow">if</span> (status == <a class="code" href="group__group__dfu__enums.html#ggafcff247e9cb8dc6c1282873b0d2dae1ba225cb8ce9902215fa03c9b0c77ac6e23">CY_DFU_SUCCESS</a>)</div><div class="line">           {</div><div class="line">               <a class="code" href="group__group__dfu__functions__transport.html#gaa979bcdabc0bb7dc392be24a25986ca9">Cy_DFU_TransportStop</a>();</div><div class="line">               <a class="code" href="group__group__dfu__functions__app.html#ga462d2b960d0a1420bd365cbb12173266">Cy_DFU_ExecuteApp</a>(1u);</div><div class="line">           }</div><div class="line">           <span class="keywordflow">else</span> <span class="keywordflow">if</span> (status == <a class="code" href="group__group__dfu__enums.html#ggafcff247e9cb8dc6c1282873b0d2dae1ba5ec17ddd14f6e0a3ac1ad893d3cef065">CY_DFU_ERROR_VERIFY</a>)</div><div class="line">           {</div><div class="line">               <span class="comment">/*</span></div><div class="line"><span class="comment">               * Restarts loading, an alternatives are to Halt MCU here</span></div><div class="line"><span class="comment">               * or switch to the other app if it is valid.</span></div><div class="line"><span class="comment">               * Error code may be handled here, i.e. print to debug UART.</span></div><div class="line"><span class="comment">               */</span></div><div class="line">               status = <a class="code" href="group__group__dfu__functions.html#ga803512d54a676efd3ecfd12f531c2e30">Cy_DFU_Init</a>(&amp;state, &amp;dfuParams);</div><div class="line">               <a class="code" href="group__group__dfu__functions__transport.html#gaf440cbe4ded2f8090c51fe7c23a00e8c">Cy_DFU_TransportReset</a>();</div><div class="line">           }</div><div class="line">        }</div><div class="line">        <span class="keywordflow">else</span> <span class="keywordflow">if</span> (state == <a class="code" href="group__group__dfu__macro__state.html#gab0ee6f2a05184dcf2ded6f3e1c6ff74b">CY_DFU_STATE_FAILED</a>)</div><div class="line">        {</div><div class="line">           <span class="comment">/* An error has happened during the loading process */</span></div><div class="line">           <span class="comment">/* Handle it here */</span></div><div class="line"></div><div class="line">           <span class="comment">/* In this Code Example just restart loading process */</span></div><div class="line">           status = <a class="code" href="group__group__dfu__functions.html#ga803512d54a676efd3ecfd12f531c2e30">Cy_DFU_Init</a>(&amp;state, &amp;dfuParams);</div><div class="line">           <a class="code" href="group__group__dfu__functions__transport.html#gaf440cbe4ded2f8090c51fe7c23a00e8c">Cy_DFU_TransportReset</a>();</div><div class="line">        }</div><div class="line">        <span class="keywordflow">else</span> <span class="keywordflow">if</span> (state == <a class="code" href="group__group__dfu__macro__state.html#gac52da0b4bc0d00ccef1726e7ab639817">CY_DFU_STATE_UPDATING</a>)</div><div class="line">        {</div><div class="line">           uint32_t passed5seconds = (count &gt;= (5000ul/paramsTimeout)) ? 1u : 0u;</div><div class="line">           <span class="comment">/*</span></div><div class="line"><span class="comment">           * if no command has been received during 5 seconds when the loading</span></div><div class="line"><span class="comment">           * has started then restart loading.</span></div><div class="line"><span class="comment">           */</span></div><div class="line">           <span class="keywordflow">if</span> (status == <a class="code" href="group__group__dfu__enums.html#ggafcff247e9cb8dc6c1282873b0d2dae1ba225cb8ce9902215fa03c9b0c77ac6e23">CY_DFU_SUCCESS</a>)</div><div class="line">           {</div><div class="line">               count = 0u;</div><div class="line">           }</div><div class="line">           <span class="keywordflow">else</span> <span class="keywordflow">if</span> (status == <a class="code" href="group__group__dfu__enums.html#ggafcff247e9cb8dc6c1282873b0d2dae1badccb00d92664320cfae8448b0811eb09">CY_DFU_ERROR_TIMEOUT</a>)</div><div class="line">           {</div><div class="line">               <span class="keywordflow">if</span> (passed5seconds != 0u)</div><div class="line">               {</div><div class="line">                   count = 0u;</div><div class="line">                   <a class="code" href="group__group__dfu__functions.html#ga803512d54a676efd3ecfd12f531c2e30">Cy_DFU_Init</a>(&amp;state, &amp;dfuParams);</div><div class="line">                   <a class="code" href="group__group__dfu__functions__transport.html#gaf440cbe4ded2f8090c51fe7c23a00e8c">Cy_DFU_TransportReset</a>();</div><div class="line">               }</div><div class="line">           }</div><div class="line">           <span class="keywordflow">else</span></div><div class="line">           {</div><div class="line">               count = 0u;</div><div class="line">               <span class="comment">/* Delay because Transport still may be sending error response to a host */</span></div><div class="line">               Cy_SysLib_Delay(paramsTimeout);</div><div class="line">               <a class="code" href="group__group__dfu__functions.html#ga803512d54a676efd3ecfd12f531c2e30">Cy_DFU_Init</a>(&amp;state, &amp;dfuParams);</div><div class="line">               <a class="code" href="group__group__dfu__functions__transport.html#gaf440cbe4ded2f8090c51fe7c23a00e8c">Cy_DFU_TransportReset</a>();</div><div class="line">           }</div><div class="line">        }</div></div><!-- fragment --> <dl class="section warning"><dt>Warning</dt><dd>An additional timeout in the main loop can break the DFU transfer. For example, CY8CKIT-149 Hello_World template application uses the 0.5 seconds delay for the LED blinking. This needs to be disabled during the DFU image transfer.</dd></dl>
</li>
<li><p class="startli">Update the main loop with a routine to switch to the loaded QSG_DFU_App1_Hello_World application:</p>
<p class="startli">For example, to switch by pressing the kit user button using HAL drivers:</p><ul>
<li>Add pin initialization to the main() function initialization section: <div class="fragment"><div class="line">    <span class="comment">/* Initialize the User Button */</span></div><div class="line">    cyhal_gpio_init(CYBSP_USER_BTN, CYHAL_GPIO_DIR_INPUT, CYHAL_GPIO_DRIVE_PULLUP, CYBSP_BTN_OFF);</div></div><!-- fragment --></li>
<li>Add the following routine to the main loop section: <div class="fragment"><div class="line">        <span class="comment">/* Check if User button is pressed */</span></div><div class="line">        <span class="keywordflow">if</span> (cyhal_gpio_read(CYBSP_USER_BTN) == CYBSP_BTN_PRESSED)</div><div class="line">        {</div><div class="line">            <span class="comment">/* 50 ms delay for button debounce on button press */</span></div><div class="line">            cyhal_system_delay_ms(50u);</div><div class="line">            <span class="keywordflow">if</span> (cyhal_gpio_read(CYBSP_USER_BTN) == CYBSP_BTN_PRESSED)</div><div class="line">            {</div><div class="line">                <span class="keywordflow">while</span> (cyhal_gpio_read(CYBSP_USER_BTN) == CYBSP_BTN_PRESSED)</div><div class="line">                {   <span class="comment">/* 50 ms delay for button debounce on button release */</span></div><div class="line">                    cyhal_system_delay_ms(50u);</div><div class="line">                }</div><div class="line">                <span class="comment">/* Validate and switch to App1 */</span></div><div class="line">                status = <a class="code" href="group__group__dfu__functions__app.html#gae4eed95b94cdb006c79e2036f01d7fc4">Cy_DFU_ValidateApp</a>(1u, &amp;dfuParams);</div><div class="line">                <span class="keywordflow">if</span> (status == <a class="code" href="group__group__dfu__enums.html#ggafcff247e9cb8dc6c1282873b0d2dae1ba225cb8ce9902215fa03c9b0c77ac6e23">CY_DFU_SUCCESS</a>)</div><div class="line">                {</div><div class="line">                    <a class="code" href="group__group__dfu__functions__transport.html#gaa979bcdabc0bb7dc392be24a25986ca9">Cy_DFU_TransportStop</a>();</div><div class="line">                    <a class="code" href="group__group__dfu__functions__app.html#ga462d2b960d0a1420bd365cbb12173266">Cy_DFU_ExecuteApp</a>(1u);</div><div class="line">                }</div><div class="line">            }</div><div class="line">        }</div></div><!-- fragment --> <dl class="section note"><dt>Note</dt><dd>For the CAT2 device, to use HAL drivers add mtb-hal-cat2 library in the Library Manager add the CY_USING_HAL define to the Makefile: <div class="fragment"><div class="line">DEFINES=CY_USING_HAL </div></div><!-- fragment --> include cyhal.h in the main.c <div class="fragment"><div class="line"><span class="preprocessor">#include &quot;cyhal.h&quot;</span> </div></div><!-- fragment --></dd></dl>
</li>
</ul>
</li>
</ol>
<h3><a class="anchor" id="ssection_dfu_step_3"></a>
STEP 3: Build and Program Loader QSG_DFU_App0_I2C</h3>
<ol type="1">
<li>Update the project Makefile to use the previously copied DFU linker script by setting the LINKER_SCRIPT variable.<ul>
<li>CY8CKIT-062-WIFI-BT + GCC_ARM: <div class="fragment"><div class="line">LINKER_SCRIPT=dfu_cm4_app0.ld </div></div><!-- fragment --></li>
<li>CY8CKIT-149 + GCC_ARM: <div class="fragment"><div class="line">LINKER_SCRIPT=dfu_cm0p_app0.ld </div></div><!-- fragment --></li>
</ul>
</li>
<li>Connect your kit to the computer. Build and program the device. <dl class="section warning"><dt>Warning</dt><dd>The DFU loader application requires an XRES reset after programming to initialize the <em>ram_common</em> data section.</dd></dl>
</li>
<li>Observe the kit LED blinking.</li>
</ol>
<p><a class="anchor" id="loadable_DFU_app_steps"></a></p>
<h3><a class="anchor" id="ssection_dfu_step_4"></a>
STEP 4: Setup Loadable QSG_DFU_App1_Hello_World</h3>
<ol type="1">
<li>Copy the app1 linker script file and put them next to main.c. The linker script files are located at:<ul>
<li>CY8CKIT-062-WIFI-BT kit: <br />
 [[dfu location]]\[VERSION]\linker_scripts\CAT1A\TOOLCHAIN_&lt;COMPILER&gt;\dfu_cm4_app1.[ext]</li>
<li>CY8CKIT-149 kit: <br />
 [[dfu location]]\[VERSION]\linker_scripts\CAT2\TOOLCHAIN_&lt;COMPILER&gt;\dfu_cm0p_app1.[ext] For the GCC ARM compiler, copy dfu_cm4_app0.ld (CY8CKIT-062-WIFI-BT kit) of dfu_cm0p_app0.ld file (CY8CKIT-149 kit). <dl class="section note"><dt>Note</dt><dd>For the ARM compiler, copy additional <b>dfu_common.h</b> and <b>dfu_elf_symbols.c</b> files to the project. Those files are located in the same folder as the selected linker file.</dd></dl>
</li>
</ul>
</li>
</ol>
<h3><a class="anchor" id="ssection_dfu_step_5"></a>
STEP 5: Update Loadable QSG_DFU_App1_Hello_World main.c</h3>
<ol type="1">
<li>Update the main.c file with the .cy_app_signature section <div class="fragment"><div class="line">CY_SECTION(<span class="stringliteral">&quot;.cy_app_signature&quot;</span>) __USED static const uint32_t cy_dfu_appSignature[1];</div></div><!-- fragment --> </li>
</ol>
<h3><a class="anchor" id="ssection_dfu_step_6"></a>
STEP 6: Build and Program Patch</h3>
<ol type="1">
<li>Update the project Makefile to use the previously copied DFU linker script by setting the LINKER_SCRIPT variable.<ul>
<li>CY8CKIT-062-WIFI-BT + GCC_ARM: <div class="fragment"><div class="line">LINKER_SCRIPT=dfu_cm4_app1.ld </div></div><!-- fragment --></li>
<li>CY8CKIT-149 + GCC_ARM: <div class="fragment"><div class="line">LINKER_SCRIPT=dfu_cm0p_app1.ld </div></div><!-- fragment --></li>
</ul>
</li>
<li><p class="startli">Add the post build step to run CyMCUElfTool to generate a patch file in the *.cyacd2 format (see CyMCUElfTool User Guide):</p><ul>
<li>Update the application ELF with a CRC checksum: &lt;MCUELFTOOL&gt; &ndash;sign app.elf CRC &ndash;output app_crc.elf</li>
<li>Generate a patch file: &lt;MCUELFTOOL&gt; -P app_crc.elf &ndash;output app.cyacd2</li>
</ul>
<p class="startli">Generate a *.cyacd2 file in the project root.<br />
 </p><div class="fragment"><div class="line"><span class="preprocessor"># Path to Elf tool directory.</span></div><div class="line">CY_MCUELFTOOL_DIR=$(wildcard $(CY_TOOLS_DIR)/cymcuelftool-*)</div><div class="line"><span class="preprocessor"># CY MCU ELF tool executable path.</span></div><div class="line">ifeq ($(OS),Windows_NT)</div><div class="line">    CY_MCUELFTOOL=$(CY_MCUELFTOOL_DIR)/bin/cymcuelftool.exe</div><div class="line"><span class="keywordflow">else</span></div><div class="line">    CY_MCUELFTOOL=$(CY_MCUELFTOOL_DIR)/bin/cymcuelftool</div><div class="line">endif</div><div class="line">BINARY_PATH=./build/$(TARGET)/$(CONFIG)/$(APPNAME)</div><div class="line"># Custom post-build commands to run.</div><div class="line">POSTBUILD=<span class="stringliteral">&quot;$(CY_MCUELFTOOL)&quot;</span> --sign $(BINARY_PATH).elf \
       CRC --output $(APPNAME)_crc.elf &amp;&amp; \</div><div class="line">       <span class="stringliteral">&quot;$(CY_MCUELFTOOL)&quot;</span> -P $(APPNAME)_crc.elf --output $(APPNAME)_crc.cyacd2</div></div><!-- fragment --></li>
<li>Build a project.</li>
<li>Open the DFU Host Tool. Connect to the device. Select the generated .cyacd2 in the project root and program it to the device. <div class="image">
<img src="dfu_qsg_hti2c.png" alt="dfu_qsg_hti2c.png"/>
</div>
</li>
<li>QSG_DFU_App1_Hello_World application will start after successful programming. Observe the LED blinking and UART output.</li>
<li>Update the QSG_DFU_App1_Hello_World application (e.g. change blinking led frequency or UART output) and build it.</li>
<li>Press the kit reset button to return to the loader application and program the updated QSG_DFU_App1_Hello_World. Observe the project updated behavior. <dl class="section note"><dt>Note</dt><dd>The current application can be changed from the firmware by calling the <a class="el" href="group__group__dfu__functions__app.html#ga462d2b960d0a1420bd365cbb12173266">Cy_DFU_ExecuteApp</a> function.</dd></dl>
</li>
</ol>
<h2><a class="anchor" id="subsection_dfu_qsg_mcuboot"></a>
DFU Transport (MCUBoot compatible) flow</h2>
<h3><a class="anchor" id="subsubsection_qsg_mcuboot_description"></a>
Description</h3>
<p>The DFU supports the usage of the MCUBoot as a bootloader and provides a transport layer for transferring a new application image to the slot. Set macro CY_DFU_FLOW to CY_DFU_MCUBOOT_FLOW to enable this flow.</p>
<h3><a class="anchor" id="subsubsection_qsg_mcuboot_s1"></a>
STEP1: Projects preparation.</h3>
<ol type="1">
<li>Create a ModusToolbox(TM) application for the CAT1A or CAT1C devices. For example, the CY8CKIT-062-WIFI-BT kit can be used as CAT1A or KIT_XMC72_EVK as CAT1C. Create a new application in the ModusToolbox(TM) IDE using an appropriate BSP and an empty application as a template (Empty App). Name it "DFU_App0". For details, refer to the ModusToolbox(TM) 3.x IDE Quick Start Guide.</li>
<li>Include the DFU middleware into the project using the ModusToolbox(TM) Library Manager.</li>
<li>Add the DFU transport components to project's Makefile to enable the transport interface(s). In our case, I2C is used: <div class="fragment"><div class="line">COMPONENTS += DFU_I2C </div></div><!-- fragment --></li>
<li>Update project's Makefile to use MCUBoot flow: <div class="fragment"><div class="line">DEFINES += <a class="code" href="group__group__dfu__macro__config.html#ga7dc6b3120ee56d0f36285f3c1e8dec2d">CY_DFU_FLOW</a>=<a class="code" href="group__group__dfu__macro__config.html#ga1fd9a1a5a6386dc3d01e9b381d97ecdb">CY_DFU_MCUBOOT_FLOW</a> </div></div><!-- fragment --> <div class="fragment"><div class="line">COMPONENTS += DFU_USER </div></div><!-- fragment --></li>
</ol>
<h3><a class="anchor" id="subsubsection_qsg_mcuboot_s2"></a>
STEP2: Add DFU logic to main.c</h3>
<ol type="1">
<li>Include the required headers. <div class="fragment"><div class="line"><span class="preprocessor">#include &quot;cy_dfu.h&quot;</span></div></div><!-- fragment --></li>
<li>Initialize the variables and call the DFU initialization function: <div class="fragment"><div class="line">    <span class="comment">/*</span></div><div class="line"><span class="comment">    * Used to count seconds</span></div><div class="line"><span class="comment">    */</span></div><div class="line">    uint32_t count = 0;</div><div class="line"></div><div class="line">    <span class="comment">/* Status codes for DFU API */</span></div><div class="line">    <a class="code" href="group__group__dfu__enums.html#gafcff247e9cb8dc6c1282873b0d2dae1b">cy_en_dfu_status_t</a> status;</div><div class="line"></div><div class="line">    <span class="comment">/*</span></div><div class="line"><span class="comment">    * DFU state, one of the:</span></div><div class="line"><span class="comment">    * - CY_DFU_STATE_NONE</span></div><div class="line"><span class="comment">    * - CY_DFU_STATE_UPDATING</span></div><div class="line"><span class="comment">    * - CY_DFU_STATE_FINISHED</span></div><div class="line"><span class="comment">    * - CY_DFU_STATE_FAILED</span></div><div class="line"><span class="comment">    */</span></div><div class="line">    uint32_t state;</div><div class="line"></div><div class="line">    <span class="comment">/* Timeout for Cy_DFU_Continue(), in milliseconds */</span></div><div class="line">    <span class="keyword">const</span> uint32_t paramsTimeout = 20u;</div><div class="line"></div><div class="line">    <span class="comment">/* Buffer to store DFU commands */</span></div><div class="line">    CY_ALIGN(4) static uint8_t buffer[<a class="code" href="group__group__dfu__macro__config.html#ga01f0e598d60b05879166f93ef38cecee">CY_DFU_SIZEOF_DATA_BUFFER</a>];</div><div class="line"></div><div class="line">    <span class="comment">/* Buffer for DFU data packets for transport API */</span></div><div class="line">    CY_ALIGN(4) static uint8_t packet[<a class="code" href="group__group__dfu__macro__config.html#ga21b70d16eb321a6d2010b92c8584b782">CY_DFU_SIZEOF_CMD_BUFFER</a> ];</div><div class="line"></div><div class="line">    <span class="comment">/* DFU params, used to configure DFU */</span></div><div class="line">    <a class="code" href="group__group__dfu__data__structs.html#structcy__stc__dfu__params__t">cy_stc_dfu_params_t</a> dfuParams;</div><div class="line"></div><div class="line">    <span class="comment">/* Initialize dfuParams structure */</span></div><div class="line">    dfuParams.timeout          = paramsTimeout;</div><div class="line">    dfuParams.dataBuffer       = &amp;buffer[0];</div><div class="line">    dfuParams.packetBuffer     = &amp;packet[0];</div><div class="line"></div><div class="line">    status = <a class="code" href="group__group__dfu__functions.html#ga803512d54a676efd3ecfd12f531c2e30">Cy_DFU_Init</a>(&amp;state, &amp;dfuParams);</div><div class="line"></div><div class="line">    <span class="comment">/* Stop program execution if DFU init failed */</span></div><div class="line">    CY_ASSERT(<a class="code" href="group__group__dfu__enums.html#ggafcff247e9cb8dc6c1282873b0d2dae1ba225cb8ce9902215fa03c9b0c77ac6e23">CY_DFU_SUCCESS</a> == status);</div><div class="line"></div><div class="line">    <span class="comment">/* Set up the device based on configurator selections */</span></div><div class="line">    init_cycfg_all();</div><div class="line"></div><div class="line">    <span class="comment">/* enable interrupts */</span></div><div class="line">    __enable_irq();</div></div><!-- fragment --></li>
<li>Initialize the DFU transport layer: <div class="fragment"><div class="line">    <span class="comment">/* Initialize DFU communication */</span></div><div class="line">    <a class="code" href="group__group__dfu__functions__transport.html#gae72c860849c0ede5b2a34eaea7acbb64">Cy_DFU_TransportStart</a>(<a class="code" href="group__group__dfu__enums.html#gga375b46c7413cecb3fdc63f8d4638d137a74f139ec8e316257d10b026bedb02bdd">CY_DFU_I2C</a>);</div></div><!-- fragment --></li>
<li>Update the main loop with the Host Command/Response protocol processing: <div class="fragment"><div class="line">    status = <a class="code" href="group__group__dfu__functions.html#ga6514a9d999be746edc406fcf764d07f5">Cy_DFU_Continue</a>(&amp;state, &amp;dfuParams);</div><div class="line">    ++count;</div><div class="line">    <span class="keywordflow">if</span> (state == <a class="code" href="group__group__dfu__macro__state.html#ga75352e8101b5fe7c4de37f86b06f1d18">CY_DFU_STATE_FINISHED</a>)</div><div class="line">    {</div><div class="line">        <span class="comment">/*</span></div><div class="line"><span class="comment">        * Finished loading the application image</span></div><div class="line"><span class="comment">        * Validate the DFU application. Stop transporting if the application is valid.</span></div><div class="line"><span class="comment">        * NOTE Cy_DFU_ValidateApp should be implemented on the application level</span></div><div class="line"><span class="comment">        */</span></div><div class="line">        status = <a class="code" href="group__group__dfu__functions__app.html#gae4eed95b94cdb006c79e2036f01d7fc4">Cy_DFU_ValidateApp</a>(1u, &amp;dfuParams);</div><div class="line">        <span class="keywordflow">if</span> (status == <a class="code" href="group__group__dfu__enums.html#ggafcff247e9cb8dc6c1282873b0d2dae1ba225cb8ce9902215fa03c9b0c77ac6e23">CY_DFU_SUCCESS</a>)</div><div class="line">        {</div><div class="line">            <a class="code" href="group__group__dfu__functions__transport.html#gaa979bcdabc0bb7dc392be24a25986ca9">Cy_DFU_TransportStop</a>();</div><div class="line">        }</div><div class="line">    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (status == <a class="code" href="group__group__dfu__enums.html#ggafcff247e9cb8dc6c1282873b0d2dae1ba5ec17ddd14f6e0a3ac1ad893d3cef065">CY_DFU_ERROR_VERIFY</a>)</div><div class="line">    {</div><div class="line">        <span class="comment">/*</span></div><div class="line"><span class="comment">        * Restarts loading, the alternatives to Halt MCU are here</span></div><div class="line"><span class="comment">        * or switch to the other app if it is valid.</span></div><div class="line"><span class="comment">        * Error code can be handled here, which means print to debug UART.</span></div><div class="line"><span class="comment">        */</span></div><div class="line">        status = <a class="code" href="group__group__dfu__functions.html#ga803512d54a676efd3ecfd12f531c2e30">Cy_DFU_Init</a>(&amp;state, &amp;dfuParams);</div><div class="line">        <a class="code" href="group__group__dfu__functions__transport.html#gaf440cbe4ded2f8090c51fe7c23a00e8c">Cy_DFU_TransportReset</a>();</div><div class="line">    }</div><div class="line">    }</div><div class="line">    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (state == <a class="code" href="group__group__dfu__macro__state.html#gab0ee6f2a05184dcf2ded6f3e1c6ff74b">CY_DFU_STATE_FAILED</a>)</div><div class="line">    {</div><div class="line">       <span class="comment">/*</span></div><div class="line"><span class="comment">       * An error occurred during the loading process.</span></div><div class="line"><span class="comment">       * Handle it here. This code just restarts the loading process.</span></div><div class="line"><span class="comment">       */</span></div><div class="line">       status = <a class="code" href="group__group__dfu__functions.html#ga803512d54a676efd3ecfd12f531c2e30">Cy_DFU_Init</a>(&amp;state, &amp;dfuParams);</div><div class="line">       <a class="code" href="group__group__dfu__functions__transport.html#gaf440cbe4ded2f8090c51fe7c23a00e8c">Cy_DFU_TransportReset</a>();</div><div class="line">    }</div><div class="line">    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (state == <a class="code" href="group__group__dfu__macro__state.html#gac52da0b4bc0d00ccef1726e7ab639817">CY_DFU_STATE_UPDATING</a>)</div><div class="line">    {</div><div class="line">        <span class="comment">/*</span></div><div class="line"><span class="comment">        * The paramsTimeout variable is equal to the time DFU waits for the</span></div><div class="line"><span class="comment">        * next Host command.</span></div><div class="line"><span class="comment">        */</span></div><div class="line">        <span class="keywordtype">bool</span> passed5seconds = count &gt;= (5000UL/paramsTimeout);</div><div class="line">        <span class="comment">/*</span></div><div class="line"><span class="comment">        * if no command was received within 5 seconds after the loading</span></div><div class="line"><span class="comment">        * started, restart loading.</span></div><div class="line"><span class="comment">        */</span></div><div class="line">        <span class="keywordflow">if</span> (status == <a class="code" href="group__group__dfu__enums.html#ggafcff247e9cb8dc6c1282873b0d2dae1ba225cb8ce9902215fa03c9b0c77ac6e23">CY_DFU_SUCCESS</a>)</div><div class="line">        {</div><div class="line">            count = 0u;</div><div class="line">        }</div><div class="line">        <span class="keywordflow">else</span> <span class="keywordflow">if</span> (status == <a class="code" href="group__group__dfu__enums.html#ggafcff247e9cb8dc6c1282873b0d2dae1badccb00d92664320cfae8448b0811eb09">CY_DFU_ERROR_TIMEOUT</a>)</div><div class="line">        {</div><div class="line">            <span class="keywordflow">if</span> (passed5seconds != 0u)</div><div class="line">            {</div><div class="line">                count = 0u;</div><div class="line">                <a class="code" href="group__group__dfu__functions.html#ga803512d54a676efd3ecfd12f531c2e30">Cy_DFU_Init</a>(&amp;state, &amp;dfuParams);</div><div class="line">                <a class="code" href="group__group__dfu__functions__transport.html#gaf440cbe4ded2f8090c51fe7c23a00e8c">Cy_DFU_TransportReset</a>();</div><div class="line">            }</div><div class="line">        }</div><div class="line">        <span class="keywordflow">else</span></div><div class="line">        {</div><div class="line">            count = 0u;</div><div class="line">            <span class="comment">/* Delay because Transport still may be sending an error response to the host. */</span></div><div class="line">            Cy_SysLib_Delay(paramsTimeout);</div><div class="line">            <a class="code" href="group__group__dfu__functions.html#ga803512d54a676efd3ecfd12f531c2e30">Cy_DFU_Init</a>(&amp;state, &amp;dfuParams);</div><div class="line">            <a class="code" href="group__group__dfu__functions__transport.html#gaf440cbe4ded2f8090c51fe7c23a00e8c">Cy_DFU_TransportReset</a>();</div><div class="line">        }</div><div class="line">    }</div></div><!-- fragment --> </li>
</ol>
<h3><a class="anchor" id="subsubsection_qsg_mcuboot_s3"></a>
STEP3: Build and Program Loader DFU_App0</h3>
<p>Connect your kit to the computer. Build and program the device. </p><dl class="section note"><dt>Note</dt><dd>The CY_DFU_PRODUCT warning displays if default values are used and they need to be changed. CY_DFU_PRODUCT can be defined in the Makefile.</dd></dl>
<h3><a class="anchor" id="subsubsection_qsg_mcuboot_s4"></a>
STEP4: Create a loadable application (Application 1).</h3>
<ol type="1">
<li>Create a ModusToolbox(TM) application for the same devices as in STEP1. Use an empty application as a template (Empty App). Name it "DFU_App1".</li>
<li>Disable the adding the CM0+ core code to the result binary. For the CAT1A device (CY8CKIT-062-WIFI-BT kit), disable the CM0P_SLEEP component in Makefile. <div class="fragment"><div class="line">DISABLE_COMPONENTS=CM0P_SLEEP </div></div><!-- fragment --> For the CAT1C device (KIT_XMC72_EVK kit), disable the XMC7xDUAL_CM0P_SLEEP component in Makefile. <div class="fragment"><div class="line">DISABLE_COMPONENTS=XMC7xDUAL_CM0P_SLEEP </div></div><!-- fragment --></li>
<li>Update the project post build steps to generate HEX files with an offset to the memory region of the loadable application.</li>
</ol>
<ul>
<li>Added Makefile variables for generating the HEX file.</li>
</ul>
<div class="fragment"><div class="line">BINARY_PATH=./build/$(TARGET)/$(CONFIG)/$(APPNAME)</div><div class="line">HEX_TOOL=$(MTB_TOOLCHAIN_GCC_ARM__BASE_DIR)/bin/arm-none-eabi-objcopy</div><div class="line">HEX_TOOL_OPTIONS=-O ihex</div><div class="line">APP_OFFSET=0x00030000</div></div><!-- fragment --><ul>
<li>Add a post build step to put the loadable application at the upgradable area offset</li>
</ul>
<div class="fragment"><div class="line"><span class="preprocessor"># Custom post-build commands to run.</span></div><div class="line">POSTBUILD=\</div><div class="line">cp -f $(BINARY_PATH).hex $(BINARY_PATH)_raw.hex;\</div><div class="line">rm -f $(BINARY_PATH).hex;\</div><div class="line">$(HEX_TOOL) --change-addresses=$(APP_OFFSET) $(HEX_TOOL_OPTIONS) $(BINARY_PATH).elf $(BINARY_PATH).hex;</div></div><!-- fragment --><ol type="1">
<li>Load the application to the device using the DFU Host Tool. Refer to the DFU Host Tool user guide for the details of using the HEX file as an input. <dl class="section note"><dt>Note</dt><dd>Only DFU Host Tool v2.0 or later support the HEX file as an input.</dd></dl>
</li>
</ol>
<h1><a class="anchor" id="section_dfu_configuration"></a>
Configuration Considerations</h1>
<h2><a class="anchor" id="group_dfu_config_linker_scripts"></a>
Linker scripts</h2>
<p>The DFU SDK projects linker scripts differ from the default startup linker scripts.</p>
<p>The DFU middleware contains two sets of linker script files for the CAT1A and CAT2-based devices. The DFU linker scripts include the following files:</p><ul>
<li>CAT1A:<ul>
<li>dfu_cm4_app0.{ld, icf, scat}, dfu_cm4_app1.{ld, icf, scat} for ARM GCC, IAR, and ARM compilers.</li>
<li>dfu_common.h and dfu_elf_symbols.c for the ARM compiler.</li>
</ul>
</li>
<li>CAT2:<ul>
<li>dfu_cm0p_app0.{ld, icf, scat}, dfu_cm0p_app1.{ld, icf, scat} for ARM GCC, IAR, and ARM compilers.</li>
<li>dfu_common.h and dfu_elf_symbols.c for the ARM compiler.</li>
</ul>
</li>
</ul>
<p>These files define the symbols for the memory layout for each application inside the device.</p>
<dl class="section user"><dt>Memory layout of GCC_ARM linker scripts (dfu_{cm0p, cm4}_{app0, app1}.ld)</dt><dd></dd></dl>
<p>This part of the GCC linker script files must have the same memory layout across all the application projects in the designed device. Any changes made to any application must be copied to other applications linker script files.</p>
<p>Memory regions:</p><ul>
<li><em>flash_app{X}</em> - Code and data of the user application {X}.</li>
<li><em>flash_boot_meta</em> - For the DFU SDK metadata. Cypress DFU SDK code examples place DFU SDK metadata inside this region.</li>
<li><em>ram_common</em> - Shared between the DFU SDK applications. The user can place it anywhere inside the RAM, So, one app sets some values there, switches to another app. Then app may read or update the values.</li>
<li><em>ram_app{X}</em> - data, stack, heap etc. for the user app{X}.</li>
</ul>
<p>Also, the linker script files for CAT1A include the following memory regions:</p><ul>
<li><em>flash_cm0p</em> - Code and data of the default application CM0+ CPU. <dl class="section warning"><dt>Warning</dt><dd>There are different CM0+ images available. Please adjust the size of the CM0+ application image according to the size in BSP default linker script.</dd></dl>
</li>
<li><em>sflash_user_data</em>, <em>eFuse</em>, <em>flash_toc</em>, <em>em_eeprom</em>, <em>xip</em> - These regions are not used by typical DFU SDK code examples. They are kept because they may be used in user code.</li>
</ul>
<p>ELF file symbols: CyMCUElfTool uses special ELF file symbols besides the command-line arguments for its configuration. These symbols are defined in each linker script.</p><ol type="1">
<li><p class="startli">__cy_memory_{N}_start - Defines the start address of the memory region. __cy_memory_{N}_length - Defines the length of the memory region. __cy_memory_{N}_row_size - Defines the row size of the memory region.</p>
<p class="startli">CyMCUElfTool uses these symbols to determine which memory regions to place into the output files. I.e. without these symbols, some data, like XIP may be absent in the output file. These symbols are critical for the .cyacd2 file generation, CyMCUElfTool must know the row size of all the data being exported to the .cyacd2 file. The updating is done by rows, and a row size may vary across the memory regions.</p>
<p class="startli">E.g. The internal flash of PSoC6 devices start at address 0x1000_0000 and the length and row size may be device-dependent. For example, if the length and size are 512KB and 512 bytes, the memory symbols for the internal flash will be: </p><div class="fragment"><div class="line">__cy_memory_0_start    = 0x10000000;</div><div class="line">__cy_memory_0_length   = 512 * 1024;</div><div class="line">__cy_memory_0_row_size = 512;</div></div><!-- fragment --><p class="startli">The number _{N}_ in the memory symbol indicates that there may be multiple memories.</p>
</li>
<li>__cy_boot_metadata_addr and __cy_boot_metadata_length. These symbols are used by the DFU SDK internally to access the metadata.</li>
<li><p class="startli">__cy_product_id - used by CyMCUElfTool to be placed in the .cyacd2 header. This value is used by the updating Host and DFU SDK firmware to confirm that the .cyacd2 file being updated is compatible with the device.</p>
<p class="startli">E.g. The user may have two different devices with the same PSoC6 chip:</p><ul>
<li>A coffee machine, with Product ID - 0x1000_0001.</li>
<li>A nuclear power plant control device with Product ID - 0x1000_0002. The user of a coffee machine tries to update firmware for a nuclear power plant control device, and the DFU Host will indicate that the device rejected this firmware because of the wrong Product ID.</li>
</ul>
</li>
<li><p class="startli">__cy_app{N}_verify_start, __cy_app{N}_verify_length. These symbols are used by the dfu_user.c file to initialize the metadata. Their value is automatically updated by the linker when the user updates the memory layout (memory regions).</p>
<p class="startli">If the user decides to use a different mechanism for the SDK metadata initialization, these symbols can be removed.</p>
</li>
<li>__cy_boot_signature_size.<a class="anchor" id="__cy_boot_signature_size"></a> Used by the DFU SDK linker scripts only. It helps avoiding the magic number for a signature size to be scattered throughout all the linker scripts. E.g.<ul>
<li>For the CRC-32C application signature, the value of this symbol is 4 (bytes).</li>
<li>For RSASSA-PCKS-1-v1.5 with RSA 2048, the value is 256 (bytes).</li>
</ul>
</li>
<li>__cy_checksum_type. The checksum type for the DFU transport packet verification used by CyMCUElfTool to generate a updating file. Must be aligned with <a class="el" href="group__group__dfu__macro__config.html#ga143573a13abbb1bf5c430f6f663492e7">CY_DFU_OPT_PACKET_CRC</a></li>
</ol>
<dl class="section user"><dt>File dfu_{cm0p, cm4}_app0.ld</dt><dd></dd></dl>
<p>This file is a linker script for the app0 for DFU SDK applications.</p>
<p>It is similar to the default startup GCC's linker script but contains the following changes:</p><ol type="1">
<li>The memory regions are separated between the CPU application 0 and CPU application 1 described above. For CAT1A devices, there is an additional region for the CM0+ application.</li>
<li>The DFU-specific ELF file symbols are described above.</li>
<li>__cy_app_id. These ELF file symbols are used by CyMCUElfTool to set an application ID in the .cyacd2 file header.</li>
<li>__cy_app_verify_start, __cy_app_verify_length. These two symbols are used by CyMCUElfTool to generate an application signature. The first symbol provides a value of the start of signed memory and the second - the length of signed memory.</li>
<li>Section ".cy_boot_noinit". Used to place data to share between the applications. See the description of the ram_common memory region.</li>
<li>Section ".cy_boot_metadata". Contains the DFU SDK metadata. This section name is necessary only for CyMCUElfTool to sign the section with the CRC-32C checksum of this section data. If no CRC-32C at the end of the metadata is required, the section can be renamed.</li>
<li>Section .cy_app_signature. This section is used to place an application signature. The signature is used by the DFU SDK to verify that the application is valid. Typically, CRC, SHA or any other hash of the application code and data is placed here. CyMCUElfTool updates this section in the post-build step. The memory for which the signature is calculated is defined by the following ELF file symbols: __cy_app_verify_start, __cy_app_verify_length.</li>
</ol>
<dl class="section user"><dt>File dfu_{cm0p, cm4}_app1.ld</dt><dd></dd></dl>
<p>Used to create linker scripts for application #2, .. #N It is similar to dfu_{cm0p, cm4}_app0.ld linker script, but contains the following changes:</p><ul>
<li>Region alias for flash and ram are flash_app1 and ram_app1</li>
<li>Application ID __cy_app_id = 1</li>
<li>For CAT1A devices, removed section for CM0+ CPU as it is allocated only once in scope of the linker script dfu_cm4_app0.ld</li>
</ul>
<dl class="section user"><dt>Files dfu_{cm0p, cm4}_{app0, app1}.{icf, scat}</dt><dd></dd></dl>
<p>These files are the linker scripts for the IAR and ARM compilers for the DFU SDK applications.</p>
<p>Their difference from the default startup linker scripts is similar to the DFU SDK GCC's linker scripts described above.</p>
<h2><a class="anchor" id="group_dfu_mtb_cfg"></a>
Use of the ModusToolbox(TM) tools for HW initialization</h2>
<p>The following section describes the communication interfaces settings in the Device Configurator required to use the included with DFU middleware communication files with the DFU Host tool. </p><dl class="section warning"><dt>Warning</dt><dd>The ModusToolbox(TM) Device Configurator is not used for templates based on the HAL drivers.<br />
 Please check/setup the required pins assignments in the BSP.</dd></dl>
<dl class="section user"><dt>I2C</dt><dd><table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Parameter name  </th><th class="markdownTableHeadNone">Value   </th></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyNone">Personality alias name  </td><td class="markdownTableBodyNone">DFU_I2C   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowEven">
<td class="markdownTableBodyNone">Mode  </td><td class="markdownTableBodyNone">Slave   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyNone">Data Rate  </td><td class="markdownTableBodyNone">Any, I2C speed in DFU Host tool should be the same   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowEven">
<td class="markdownTableBodyNone">Use TX FIFO  </td><td class="markdownTableBodyNone">True   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyNone">Use RX FIFO  </td><td class="markdownTableBodyNone">True   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowEven">
<td class="markdownTableBodyNone">Slave Address  </td><td class="markdownTableBodyNone">Any, I2C address in DFU Host tool should be the same   </td></tr>
</table>
</dd></dl>
<div class="image">
<img src="dfu_basic_i2c.png" alt="dfu_basic_i2c.png"/>
</div>
<dl class="section user"><dt>SPI</dt><dd><table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Parameter name  </th><th class="markdownTableHeadNone">Value   </th></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyNone">Personality alias name  </td><td class="markdownTableBodyNone">DFU_SPI   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowEven">
<td class="markdownTableBodyNone">Mode  </td><td class="markdownTableBodyNone">Slave   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyNone">Sub Mode  </td><td class="markdownTableBodyNone">Motorola   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowEven">
<td class="markdownTableBodyNone">SCLK Mode  </td><td class="markdownTableBodyNone">Any, Sub Mode in DFU Host tool should be the same   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyNone">Data Rate  </td><td class="markdownTableBodyNone">1000 kbps (For other data rates, adjust the value of the SPI_BYTE_TO_BYTE macro in the transport_spi.c file)   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowEven">
<td class="markdownTableBodyNone">Bit Order  </td><td class="markdownTableBodyNone">Any, Shift direction in DFU Host tool should be the same   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyNone">RX Data Width  </td><td class="markdownTableBodyNone">8   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowEven">
<td class="markdownTableBodyNone">TX Data Width  </td><td class="markdownTableBodyNone">8   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyNone">SS Polarity  </td><td class="markdownTableBodyNone">Active Low   </td></tr>
</table>
</dd></dl>
<dl class="section note"><dt>Note</dt><dd>By default, used the Slave Select 1 line. To change it, update the CY_SPI_SLAVE_SELECT macro in transport_spi.c file.</dd></dl>
<dl class="section user"><dt>UART</dt><dd><table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Parameter name  </th><th class="markdownTableHeadNone">Value   </th></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyNone">Personality alias name  </td><td class="markdownTableBodyNone">DFU_UART   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowEven">
<td class="markdownTableBodyNone">Com Mode  </td><td class="markdownTableBodyNone">Standard   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyNone">Baud Rate  </td><td class="markdownTableBodyNone">115200 bps (For other baud rates, adjust the value of the UART_BYTE_TO_BYTE_TIMEOUT_US macro in transport_uart.c file)   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowEven">
<td class="markdownTableBodyNone">Bit Order  </td><td class="markdownTableBodyNone">LSB first   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyNone">Data Width  </td><td class="markdownTableBodyNone">8 bits   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowEven">
<td class="markdownTableBodyNone">Parity  </td><td class="markdownTableBodyNone">Any, Parity in DFU Host tool should be the same   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyNone">Stop Bits  </td><td class="markdownTableBodyNone">Any, Stop Bits in DFU Host tool should be the same   </td></tr>
</table>
</dd></dl>
<dl class="section user"><dt>USB CDC transports</dt><dd>For a setup of the USB device personality in the ModusToolbox Device Configurator for the USB DFU transport for CY8CKIT-062-WIFI-BT, see the screenshots below. For other kits, verify the USB pins. <div class="image">
<img src="dfu_usb_cdc.png" alt="dfu_usb_cdc.png"/>
</div>
</dd></dl>
<h1><a class="anchor" id="section_dfu_design"></a>
Design Considerations</h1>
<h2><a class="anchor" id="group_dfu_ucase_i2c"></a>
Firmware Update via I2C</h2>
<p>See <a class="el" href="index.html#section_dfu_quick_start">Quick Start Guide</a> for steps how to set up a DFU project that upgrades an application via the I2C transport interface.</p>
<h2><a class="anchor" id="group_dfu_ucase_uart"></a>
Firmware Update via UART</h2>
<p>See <a class="el" href="index.html#section_dfu_quick_start">Quick Start Guide</a> for basic steps how to setup a DFU project. Specific steps for the UART transport support:</p><ul>
<li>Add UART transport component in project's Makefile: locate <b>COMPONENTS</b> variable and add <b>DFU_UART</b>: <div class="fragment"><div class="line">COMPONENTS+=DFU_UART </div></div><!-- fragment --></li>
<li>For templates based on the PDL drivers:<ul>
<li>Select and configure the SCB block using the ModusToolbox(TM) Device Configurator see <a class="el" href="index.html#group_dfu_mtb_cfg">Use of the ModusToolbox(TM) tools for HW initialization</a> or manually using the configuration structures.</li>
<li>Adjust value of the UART_BYTE_TO_BYTE_TIMEOUT_US constant to align with UART speed in the transport_uart.c file.</li>
<li>Adjust UART interrupt priority in the UART_INTR_PRIORITY in the transport_uart.c file.</li>
</ul>
</li>
<li>Build and program a project into the device.</li>
<li>Open the DFU Host Tool. Select the UART interface. Set the UART baud rate according to the SCB UART setup in the previous step.</li>
<li>Select the *.cyacd2 application image and upload to the device.</li>
</ul>
<h2><a class="anchor" id="group_dfu_ucase_spi"></a>
Firmware Update via SPI</h2>
<p>See <a class="el" href="index.html#section_dfu_quick_start">Quick Start Guide</a> for basic steps how to set up a DFU project. The steps for the SPI transport support:</p><ul>
<li>Add SPI transport component in project's Makefile: locate <b>COMPONENTS</b> variable and add <b>DFU_SPI</b>: <div class="fragment"><div class="line">COMPONENTS+=DFU_SPI </div></div><!-- fragment --></li>
<li>For templates based on the PDL drivers:<ul>
<li>Select and configure the SCB block using the ModusToolbox(TM) Device Configurator see <a class="el" href="index.html#group_dfu_mtb_cfg">Use of the ModusToolbox(TM) tools for HW initialization</a> or manually using the configuration structures.</li>
<li>Adjust value of the SPI_BYTE_TO_BYTE constant to align with SPI speed in the transport_spi.c file.</li>
<li>Check the value of the CY_SPI_SLAVE_SELECT in the transport_spi.c file.</li>
<li>Adjust SPI interrupt priority in the SPI_INTR_PRIORITY in the transport_spi.c file.</li>
</ul>
</li>
<li>Build and program a project into the device.</li>
<li>Open the DFU Host Tool. Select the SPI interface. Set SPI mode, shift the direction and speed according to the SCB SPI setup in the previous step.</li>
<li>Select the *.cyacd2 application image and upload to the device.</li>
</ul>
<h2><a class="anchor" id="group_dfu_ucase_usb"></a>
Firmware Update via USB CDC transport</h2>
<p>See <a class="el" href="index.html#section_dfu_quick_start">Quick Start Guide</a> for basic steps how to setup a DFU project. Specific steps for the USB transport support:</p><ul>
<li>Add USB_CDC transport component in project's Makefile: locate <b>COMPONENTS</b> variable and add <b>DFU_USB_CDC</b>: <div class="fragment"><div class="line">COMPONENTS+=DFU_USB_CDC </div></div><!-- fragment --></li>
<li>Enable and configure the USB Device block using the ModusToolbox(TM) Device Configurator see <a class="el" href="index.html#group_dfu_mtb_cfg">Use of the ModusToolbox(TM) tools for HW initialization</a> or manually using the configuration structures.</li>
<li>Generate USB descriptors and USB Middleware structures using the USB Configurator. Open the USB configuration file (cycfg_usb_cdc.cyusbdev) in the DFU \export\config\COMPONENT_CAT1\COMPONENT_DFU_USB_CDC folder, then click Save to generate configuration files (cycfg_usbdev.c and cycfg_usbdev.h). These files must be included into the build flow (see USB Middleware API Reference <a class="el" href="index.html#group_dfu_more_info">More Information</a>).</li>
<li>Build and program a project into the device. Connect your Host to the USB device.</li>
<li>For the USB CDC class: open the DFU Host Tool. Select the UART interface, because the Host recognizes the USB device as a virtual UART (the name is "DFU USB CDC transport"). UART settings: baud rate - 115200, data bits - 8, stop bits - 1, parity - None.</li>
<li>Select the *.cyacd2 application image and upload to the device.</li>
</ul>
<h2><a class="anchor" id="group_dfu_ucase_emusb"></a>
Firmware Update via emUSB CDC transport</h2>
<p>Specific steps for the emUSB transport support:</p><ul>
<li>Add emUSB_CDC transport components to the project's Makefile: <div class="fragment"><div class="line">COMPONENTS+=USBD_BASE </div></div><!-- fragment --> <div class="fragment"><div class="line">COMPONENTS+=DFU_EMUSB_CDC </div></div><!-- fragment --> <div class="fragment"><div class="line">COMPONENTS+=SOFTFP </div></div><!-- fragment --></li>
</ul>
<h2><a class="anchor" id="group_dfu_ucase_checksum"></a>
Change checksum types</h2>
<p>DFU supports two types of checksums:</p><ul>
<li>transport packet checksum</li>
<li>application image checksum.</li>
</ul>
<p>For a packet, DFU supports 2 types of checksums: Basic summation and CRC-16CCITT. The basic summation checksum is computed by adding all the bytes (excluding the checksum) and then taking the 2's complement. CRC-16CCITT - the 16-bit CRC using the CCITT algorithm. The packet checksum type is selected with a macro <a class="el" href="group__group__dfu__macro__config.html#ga143573a13abbb1bf5c430f6f663492e7">CY_DFU_OPT_PACKET_CRC</a> in dfu_user.h file: 0 - basic summation (default), 1 - for CRC-16.</p>
<p>For an application image, DFU supports 2 types of checksums: CRC-32 and SHA1. SHA1 is calculated with a crypto hardware block, which is available only on CAT1A devices. The default application checksum is CRC-32. The steps to set the SHA1 checksum for an application image:</p><ul>
<li>Set <a class="el" href="group__group__dfu__macro__config.html#gaf26d1e1c21482dd7e3e41c2b24c22637">CY_DFU_OPT_CRYPTO_HW</a> macro to 1 in dfu_user.h file to enable the SHA1 calculation.</li>
<li>Symbol <a class="el" href="group__group__dfu__globals__external__elf__symbols.html#ga1a0f0de51984fd00d4a54d8a47dfed4e">__cy_checksum_type</a> = 0x01 in <a class="el" href="index.html#group_dfu_config_linker_scripts">Linker scripts</a> for each application for ARM GCC and IAR compiler. Set macro CY_CHECKSUM_TYPE to 1 in dfu_common.h for the ARM compiler.</li>
<li>Symbol <a class="el" href="index.html#__cy_boot_signature_size">__cy_boot_signature_size</a> = 20 in <a class="el" href="index.html#group_dfu_config_linker_scripts">Linker scripts</a> for each application for the ARM GCC and IAR compilers. Set macro CY_BOOT_SIGNATURE_SIZE to 20 in dfu_common.h for the ARM compiler.</li>
<li>Configure and start crypto a server and crypto client (see PDL API Reference in <a class="el" href="index.html#group_dfu_more_info">More Information</a>) in the loader application main routine.</li>
<li>Allocate the ".cy_app_signature" section with a 20-byte array in the main of the loading application.</li>
</ul>
<h2><a class="anchor" id="group_dfu_ucase_multiapp"></a>
Multi-application DFU project</h2>
<p>The DFU design does not limit the number of applications but it is limited by memory size and metadata size. The maximum size of DFU metadata is limited to the size of the flash row, because metadata should be in a single flash row. For example, the 512-byte metadata supports up to 63 applications. An arbitrary number of applications can be protected from overwriting. Such a protected application is called "Golden Image". See <a class="el" href="index.html#section_dfu_quick_start">Quick Start Guide</a> for a steps to setup basic 2 application DFU projects. The following steps show how to set up a 3rd application. The same approach can be used to setup 4th - Nth applications.</p><ul>
<li>Define the sizes for each of the three applications and define the start and size of each memory region (flash, RAM) for each application.</li>
<li>Copy the linker script dfu_cm4_app1 from DFU linker_scripts folder according to the selected compiler and rename it (for example dfu_cm4_app2).</li>
<li>Add flash and RAM sections to the 3rd application. Name them flash_app2, ram_app2.</li>
<li>Update the size and start address for each section in each linker script based on the defined in the first step allocation.</li>
<li>Set __cy_app_id symbol to 2</li>
<li>Update the region aliases for flash and RAM to use flash_app2 and ram_app2 accordingly: <div class="fragment"><div class="line">REGION_ALIAS(<span class="stringliteral">&quot;flash&quot;</span>, flash_app2);</div><div class="line">REGION_ALIAS(<span class="stringliteral">&quot;ram&quot;</span>,     ram_app2);</div></div><!-- fragment --></li>
<li>Add symbols __cy_app2_verify_start and __cy_app2_verify_length for metadata initialization in the same way as for application 0 and 1.</li>
<li>Add a macro to the dfu_user.h CY_DFU_APP2_VERIFY_START and CY_DFU_APP2_VERIFY_LENGTH in the same way as for application 0 and 1</li>
<li>Add to the cy_dfu_metadata array of the dfu_user.c CY_DFU_APP2_VERIFY_START and CY_DFU_APP2_VERIFY_LENGTH to update the metadata with the 3rd application.</li>
<li>Update you build scripts to use the dfu_cm4_app2 linker script.</li>
</ul>
<p>Protect the application image by setting parameters in the dfu_user.h file of the loader project: <a class="el" href="group__group__dfu__macro__config.html#ga93f01cd0c868966a20c08369779fc707">CY_DFU_OPT_GOLDEN_IMAGE</a> set to 1 to enable the Golden Image functionality. <a class="el" href="group__group__dfu__macro__config.html#gaadc5be8ec2c8b42394ca06ffb123c023">CY_DFU_GOLDEN_IMAGE_IDS</a> lists the number of images that to be protected.</p>
<h2><a class="anchor" id="group_dfu_ucase_cyacd2"></a>
Creation of the CYACD2 file</h2>
<p>The .cyacd2 file contains downloadable application data created by CyMCUElfTool and used by host programs such as Cypress DFU Host Program and CySmart to send applications to the target DFU module (see <a class="el" href="index.html#group_dfu_more_info">More Information</a>). Refer to the <a href="https://www.infineon.com/an213924">AN213924</a> DFU SDK User Guide for the .cyacd2 file format. See the <a class="el" href="index.html#loadable_DFU_app_steps">Loadable Application Setup</a> section of the <a class="el" href="index.html#section_dfu_quick_start">Quick Start Guide</a> for the steps to convert a general application into a DFU loadable application.</p>
<p>The steps to create a .cyacd2 file with a CRC application signature:</p><ol type="1">
<li>Copy the path to the CyMCUElfTool binary. The path can be found in the folder with ModusToolbox tools (for example /ModusToolbox/tools_2.0/cymcuelftool-1.0/bin/cymcuelftool).</li>
<li>Update the application ELF with a CRC checksum (&lt;MCUELFTOOL&gt; - the copied path to the binary): <div class="fragment"><div class="line">&lt;MCUELFTOOL&gt; --sign app.elf CRC --output app_crc.elf </div></div><!-- fragment --></li>
<li>Generate a .cyacd2 file: <div class="fragment"><div class="line">&lt;MCUELFTOOL&gt; -P app_crc.elf --output app.cyacd2 </div></div><!-- fragment --></li>
</ol>
<p>These commands can be added as post build steps to the build Makefile.</p>
<p>For the SHA1 application signature, use command (<a class="el" href="index.html#group_dfu_ucase_checksum">Change checksum types</a>): </p><div class="fragment"><div class="line">&lt;MCUELFTOOL&gt; --sign app.elf SHA1 --output app_crc.elf </div></div><!-- fragment --><h1><a class="anchor" id="group_dfu_changelog"></a>
Changelog</h1>
<table class="doxtable">
<tr>
<th>Version</th><th>Changes</th><th>Reason for Change </th></tr>
<tr>
<td rowspan="3">5.1 </td><td>Added USB CDC transport based on the emUSB-Device middleware for the CAT1A device </td><td>Extending the current feature </td></tr>
<tr>
<td>Minor updates in the templates </td><td>Improved the templates usability  </td></tr>
<tr>
<td>Corrected the name of the UART object used in the cyhal_uart_set_baud() function </td><td>Now, works correctly the custom baud rate configuring in the UART transport  </td></tr>
<tr>
<td rowspan="5">5.0 </td><td>Add support of the MCUBoot flow. </td><td>New functionality.  </td></tr>
<tr>
<td>Add support of the transport switching at the run time.  </td><td>New functionality.   </td></tr>
<tr>
<td>CAT1 device flash read/write operation and I2C/SPI/UART transport templates updated to use mtb-hal-cat1 drivers instead of mtb-pdl-cat1.  </td><td>Enhance code portability.   </td></tr>
<tr>
<td>Removed Cy_DFU_Complete function as not used.  </td><td>Code cleanup.   </td></tr>
<tr>
<td>Removed CAT1A BLE transport templates.  </td><td>BLESS stack is not supported in the MTB 3.0.   </td></tr>
<tr>
<td rowspan="3">4.20 </td><td>Added USB CDC transport configuration for the CAT2 PDL. </td><td>Add support for the USB interface for the PMG1 device family.  </td></tr>
<tr>
<td>Updated timeout time for the CAT1A SPI transport.  </td><td>Fixed the DFU Host Tool timeout error for the CAT1A SPI transport caused by the incorrect function call (transport_spi.c file, SPI_SpiCyBtldrCommRead() function).   </td></tr>
<tr>
<td>Minor documentation update. </td><td>Documentation improvement.  </td></tr>
<tr>
<td rowspan="3">4.10 </td><td>Added PSoC 4 devices support.  </td><td>Extended device support.   </td></tr>
<tr>
<td>Added MISRA-C:2012 compliance. </td><td>MISRA standard compliance.  </td></tr>
<tr>
<td>Updated SPI communication timeout granularity. </td><td>Fixed SPI communication issue.  </td></tr>
<tr>
<td rowspan="6">4.0 </td><td>Updated the linker scripts to use the single pre-compiled CM0p image. The upgradeable part of the image is the CM4 application. </td><td>Support ModusToolbox v2.0 build flow.  </td></tr>
<tr>
<td>Added the ARM compiler version 6 support (version 5 is not supported). </td><td></td></tr>
<tr>
<td>Added the USB interface (virtual COM port) transport template. </td><td></td></tr>
<tr>
<td>Removed the Secure Application Formats support. </td><td>Secure Application Formats is not supported in ModusToolbox v2.0 build flow.  </td></tr>
<tr>
<td>Fixed the return value for the SYNC command processing. </td><td>The SYCN command returned fail after successful execution.  </td></tr>
<tr>
<td>Updated the major and minor version defines to follow the naming convention. </td><td></td></tr>
<tr>
<td rowspan="2">3.10 </td><td>Remove the function prototype from the MDK linker script include file. </td><td>Fix the linker error for the MDK compiler.  </td></tr>
<tr>
<td>Add BLE transport templates. </td><td>Add BLE middleware support.  </td></tr>
<tr>
<td rowspan="2">3.0 </td><td>Bootloader SDK is renamed to the DFU (Device Firmware Update) SDK. All API prefixes and file names are renamed accordingly. <br />
 Added BWC macros to simplify migration.  </td><td>Avoid the confusion with the device boot-up and OS load.  </td></tr>
<tr>
<td>Flattened the organization of the driver source code into the single source directory and the single include directory.  </td><td>Driver library directory-structure simplification.  </td></tr>
<tr>
<td rowspan="2">2.20 </td><td>Add check of application number in Set Application Metadata command processing routine.  </td><td>Prevent incorrect usage of the Set Application Metadata command.   </td></tr>
<tr>
<td>Minor documentation updates </td><td>Documentation improvement  </td></tr>
<tr>
<td>2.10 </td><td>Moved address and golden image checks from cy_dfu.c to <a class="el" href="group__group__dfu__functions__mem.html#ga9f589c0df780bd29477ab4d73cf4063b">Cy_DFU_WriteData()</a> in dfu_user.c, so the checks can be customized based on application needs.  </td><td>Allows receiving an update for the running app use case. Improvements made based on usability feedback. Documentation update and clarification.   </td></tr>
<tr>
<td>2.0 </td><td><ul>
<li>
Use the shared RAM for application switching instead of the BACKUP register. </li>
<li>
Add support of secure application verification. </li>
<li>
Add support of I2C/SPI/BLE transport protocols. </li>
<li>
Linker scripts updated for PSoC6 Rev *A devices. </li>
<li>
Made CRC default application checksum. </li>
</ul>
</td><td>To increase functionality.  </td></tr>
<tr>
<td>1.0 </td><td>Initial version. </td><td></td></tr>
</table>
<h1><a class="anchor" id="group_dfu_more_info"></a>
More Information</h1>
<p>For more information, refer to the links in the <a href="https://github.com/Infineon/dfu/blob/master/README.md#more-information">README.md</a> </p>
</div></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part
<div id="nav-path" class="navpath">
    <ul>
        <li class="footer">
            Generated for <b>Device Firmware Update (DFU) Middleware Library 5.1</b> by <b>Cypress Semiconductor Corporation</b>.
            All rights reserved.
        </li>
    </ul>
</div>
-->
</body>
</html>
